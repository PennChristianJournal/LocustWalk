extends ../_layout.pug
include ../../_mixins

block head
  link(rel="stylesheet" href="/bower_components/medium-editor/dist/css/medium-editor.min.css" type="text/css" media="screen" charset="utf-8")
  link(rel="stylesheet" href="/bower_components/medium-editor/dist/css/themes/default.css")
  link(rel="stylesheet" href="/bower_components/medium-editor-insert-plugin/dist/css/medium-editor-insert-plugin.min.css")
  link(rel='stylesheet' href='/css/article.css')
  link(href='/css/article-thumb.css' rel='stylesheet' type='text/css')

  title Editing - !{article.title}

  style.
    .medium-editor-insert-plugin.medium-editor-placeholder:after {
      padding: 0;
    }

    .medium-insert-images figure figcaption, .mediumInsert figure figcaption, .medium-insert-embeds figure figcaption, .mediumInsert-embeds figure figcaption {
      color: #888;
    }

    .fa {
      line-height: 2
    }


    .twitter-typeahead {
      display: block!important;
    }

    .tt-dropdown-menu { 
      width: 100%;
      & > div {
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 0 10px 0 black;
        background-color: white;
      }
    }
    .tt-suggestion {
      padding: 2px 10px;
      line-height: 24px;
      color: #333;
      p {
        margin: 0;
      }
    }

    .tt-suggestion.tt-cursor,.tt-suggestion:hover {
      color: #fff;
      background-color: #0097cf;
    }

    .tt-hint {
      color: #999
    }

    .tt-menu {
      width: 100%;
      background-color: white;
      border: 1px solid gray;
    }

block content

  .article
    //- div.article-cover.article-cover-change-btn#change-cover
    //-   if article.cover
    //-     img#cover-photo(src='/files/#{article.cover}')
    //-   else
    //-     img#cover-photo(src='')
    //- div.article-title.editable-title #{article.title}
    //- div.article-content.editable-content !{article.content}
    .article-cover.article-cover-change-btn#change-cover(style=`background-image:url(/files/${article.cover})`)
    .nav-mask
      .article-cover-blur#change-cover-blur(style=`background-image:url(/files/${article.cover})`)
      .nav-mask-bg

    .container

      if parent
        .response-to
          h2 In Response To:&nbsp;
            a(href=`/articles/${parent.slug}`) !{parent.title}

      h1.article-title.strong.editable-title !{article.title}
      h4.article-author-date.thin #{article.author} &#8212; #{moment(article.date).format('MMM DD, YYYY')}

      .article-content.editable-content !{article.content}

      if responses && responses.length > 0
        h1.strong Discussion
        .discussion.tile.tile-vertical.gray-theme
          each response, index in responses          
            +article-thumb(response)

  br
  br

  .container
    hr
    form(action='sync' method='POST' class='form')
      label Pull from Google Drive
      br
      .row
        .col-sm-6
          .form-group
            input.form-control(id='doc-search' placeholder='Document Title')
        .col-sm-6
          .form-group
            input.form-control(id='doc-id-input' name='doc_id' placeholder='Document ID' readonly)
      .form-group
        button.btn(type='submit' class='btn btn-default' onclick="return confirm('Content on this page will be replaced. Are you sure?')") Sync
    hr
    form#article-form(action='edit' method='post' enctype="multipart/form-data")
      input#title-field(type='hidden' name='title')
      input#content-field(type='hidden' name='content')

      .form-group
        label Cover Photo
        input#cover-photo-input(type='file' name='cover' onchange='handleCoverImage([document.getElementById("change-cover"), document.getElementById("change-cover-blur")], this.files)' accept='image/*')

      .form-group
        label Author
        input.form-control(type='text' name='author' placeholder='author' value=article.author)

      .form-group
        label Slug
        input.form-control(type='text' name='slug' placeholder='article-title (leave blank for automatic)' value=article.slug)

      .form-group
        label Response To
        if article.parent
          input.form-control(type='text' name='parent' placeholder='Article ID' value=article.parent.toString())
        else
          input.form-control(type='text' name='parent' placeholder='Article ID')

      .form-group
        .checkbox
          label.checkbox-inline
            if article.is_featured
              input(name='is_featured' type='checkbox' checked)
            else  
              input(name='is_featured' type='checkbox')
            | Featured
          label.checkbox-inline
            if article.is_published
              input(name='is_published' type='checkbox' checked) 
            else 
              input(name='is_published' type='checkbox')
            | Published
      .form-group
        label Thumbnail
        br
        img#thumbnail(width='400px' height='300px' src=`/files/${article.thumb}`)
        input(type='file' name='thumb' onchange='handleImage(this, document.getElementById("thumbnail"), this.files)' accept='image/*')

      .form-group
        label Post Date Override
        input.form-control#date-input(type='text' placeholder='May 16, 2016 at 13:12 (leave blank for automatic or previous)')
        if article.is_published
          input#date-field(type='hidden' name='date')
        else
          input#date-field(type='hidden' name='date' value='#{article.date}')

      .form-group
        label Heading Override
        input.form-control(type='text' name='heading_override' placeholder='Jun 2016 Special Feature (leave blank for automatic' value=article.heading_override)

      button.btn.btn-primary(type='submit') Save
      

block footer
  script(src='/bower_components/medium-editor/dist/js/medium-editor.min.js')
  script(src="/bower_components/handlebars/handlebars.runtime.min.js")
  script(src="/bower_components/jquery-sortable/source/js/jquery-sortable-min.js")
  script(src="/bower_components/blueimp-file-upload/js/vendor/jquery.ui.widget.js")
  script(src="/bower_components/blueimp-file-upload/js/jquery.iframe-transport.js")
  script(src="/bower_components/blueimp-file-upload/js/jquery.fileupload.js")
  script(src="/bower_components/medium-editor-insert-plugin/dist/js/medium-editor-insert-plugin.min.js")
  script(src='/bower_components/moment/min/moment.min.js')
  script(src='/bower_components/typeahead.js/dist/bloodhound.min.js')
  script(src='/bower_components/typeahead.js/dist/typeahead.bundle.min.js')
  script.
    var titleEditor = new MediumEditor('.editable-title', {
      placeholder: {
        text: 'New Article',
        hideOnClick: false
      },
      toolbar: false,
      disableReturn: true,
      disableDoubleReturn: true
    })

    var contentEditor = new MediumEditor('.editable-content', {
      placeholder: {
        text: 'Article content...',
        hideOnClick: false
      },
      toolbar: {
        buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote', 'superscript', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'],
      }
    })

    $('.editable-content').mediumInsert({
      editor: contentEditor,
      addons: {
        images: {
          fileUploadOptions: {
            url: 'imageupload',
            acceptFileTypes: /(.|\/)(gif|jpe?g|png)$/i
          },
          deleteScript: 'imagedelete',
          deleteMethod: 'POST',
        }
      }
    })

    $('#change-cover').on('click', function(e) {
      e.preventDefault()
      $('#cover-photo-input').click()
    })

    var handleImage = function(el, img, files) {
      var file = files[0]
      if (!file) return
      var imageType = /^image\//
      if (!imageType.test(file.type)) {
        el.value = ''
        img.src =''
        alert('Please select an image file')
        return;
      }
      img.src = window.URL.createObjectURL(file)
    }

    var handleCoverImage = function(els, files) {
      var file = files[0]
      if (!file) return
      var imageType = /^image\//
      var src = window.URL.createObjectURL(file)
      
      if (!imageType.test(file.type)) {
        alert('Please select an image file')
        return
      }
      for (var i = 0; i < els.length; i++) {
        var el = els[i]
        el.style.backgroundImage = 'url(' + src + ')'
      }
    }

    $('#article-form').submit(function() {
      $('#title-field').val(titleEditor.serialize()['element-0'].value)
      $('#content-field').val(contentEditor.serialize()['element-0'].value)
      var date = moment($('#date-input').val(), 'MMM DD, YYYY [at] H:mm')
      if ($('#date-input').val() && date.isValid()) {
        $('#date-field').val(date)
      }
    })

    var documentSearch = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      remote: {
        url: '/admin/articles/search/docs?name=%QUERY',
        wildcard: '%QUERY',
      }
    })

    documentSearch.initialize()
    $('#doc-search').typeahead(null, {
      hint: true,
      highlight: true,
      minLength: 1,
      source: documentSearch.ttAdapter(),
      display: 'name',
    })
    $('#doc-search').on('typeahead:selected typeahead:autocompleted', function(e, datum) {
      $('#doc-id-input').val(datum.id)
    })
